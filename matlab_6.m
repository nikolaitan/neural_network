%% 系统辨识与数据生成
%% Системная идентификация и генерация данных
clear; clc; close all;

% 参数设置
% Параметры
K = 1.5; Tm = 0.05; % 假设传递函数参数 | Параметры функции передачи гипотезы
Ts = 0.01; % 采样时间 | Время выборки
t = 0:Ts:10; % 时间向量（10秒） | вектор времени (10 секунд)

% 生成真实系统响应（带噪声）
% Создание реального системного ответа (с шумом)
G = tf(K, [Tm 1 0]);
[y_true, t] = step(G, t);
noise = 0.005 * max(y_true) * randn(size(y_true)); % 0.5%噪声 | 0,5% Шум
y_measured = y_true + noise;

% 添加负载扰动（模拟±5%惯量变化）
% Добавление возмущений нагрузки (моделирование изменения инерции ±5%)
disturbance = 0.05 * sin(2*pi*0.5*t);
y_disturbed = y_measured .* (1 + disturbance);

% 生成输入信号（示例：随机方波）
% генерирует входной сигнал (пример: случайные квадратные волны)
u = sign(randn(1, length(t)));  % 随机方波输入（±1V） | Случайный вход квадратной волны (±1V)
u = u * 2;                      % 调整幅度到 ±2V | Корректировка до ±2V
u = u';                         % 转置为列向量 | Преобразовать в вектор столбца

%% 创建包含输入/输出数据的iddata对象
%% Создать объект iddata, содержащий данные ввода / вывода
data = iddata(y_disturbed, u, Ts);  % 关键修复：输入数据 u | Ключевое восстановление: вводные данные u

%% 使用tfest进行传递函数估计
%% использует tfest для оценки функции передачи
sys_estimated = tfest(data, 2);     % 正确执行系统辨识 | Правильно выполнить идентификацию системы

% 验证辨识结果
% Проверить результаты идентификации
figure;
compare(data, sys_estimated); % 原始数据与辨识模型对比 | Сопоставление исходных данных с моделью идентификации
grid on;
title('Проверка результатов идентификации системы');

%% Ziegler-Nichols PID整定
%% Ziegler - Nichols PID Настройка
% 假设通过开环测试获得临界增益Ku和振荡周期Pu
%  Предположение о критическом усилении Ku и цикле колебаний Pu
Ku = 1.2; Pu = 2.0; % 示例值，实际需实验测定 | Примерное значение, фактически требующее экспериментального измерения

% 计算PID参数
% Расчет параметров PID
Kp = 0.6*Ku;
Ki = 1.2*Ku/Pu;
Kd = 0.075*Ku*Pu;

% 构建PID控制器
% Построить PID контроллер
C_pid = pid(Kp, Ki, Kd);

%% 闭环仿真验证（手动限幅）
%% Проверка эмуляции с закрытым контуром (ручное ограничение)
[~, y_pid, ~] = lsim(C_pid, step_ref, t);
y_pid_limited = min(max(y_pid, -3.5), 3.5);  % 手动限幅到[-3.5, 3.5]

%% 绘制仿真结果
%% Результаты моделирования
figure;
plot(t, step_ref, 'k:', 'LineWidth', 1.5); hold on;
plot(t, y_pid_limited, 'g-', 'LineWidth', 1.5);  % 使用限幅后的输出 | Экспорт после использования лимита
plot(t, y_disturbed, 'r--', 'LineWidth', 1.5);
xlabel('Время(s)'); ylabel('угол выхода(°)');
legend('эталонный сигнал', 'PID контрольный выход', 'фактический ответ с шумом');
title('Проверка производительности управления замкнутым циклом PID');
grid on;